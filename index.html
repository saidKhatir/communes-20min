<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Où habiter à 30 min du travail ?</title>
    
     <!-- MapLibre GL JS -->
     <script src="https://unpkg.com/maplibre-gl@^5.15.0/dist/maplibre-gl.js"></script>
     <link href="https://unpkg.com/maplibre-gl@^5.15.0/dist/maplibre-gl.css" rel="stylesheet" />
    
     <!-- Turf.js -->
    <script src="https://cdn.jsdelivr.net/npm/@turf/turf@7/turf.min.js"></script>
    
    <!-- Fuse.js pour recherche floue -->
    <script src="https://cdn.jsdelivr.net/npm/fuse.js@7.0.0/dist/fuse.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    
    <!-- Styles locaux -->
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- Header avec recherche -->
        <header class="header">
        <div class="header-top">
            <h1 class="header-title">Où habiter à 30 min du travail ?</h1>
            <button class="help-btn" id="help-btn" title="Informations">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"></circle>
                    <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
                    <line x1="12" y1="17" x2="12.01" y2="17"></line>
                </svg>
            </button>
        </div>
        <p class="header-subtitle">Communes accessibles en voiture depuis le lieu de travail, en conditions de trafic fluide</p>
        <div class="search-container">
            <input 
                type="text" 
                id="search-input" 
                class="search-input" 
                placeholder="Rechercher une commune..."
                autocomplete="off"
            >
            <div id="search-results" class="search-results hidden"></div>
        </div>
    </header>

    <!-- Carte -->
    <div id="map" class="map-container"></div>

    <!-- Bouton pour ouvrir le tableau -->
    <button id="toggle-table-btn" class="toggle-table-btn" title="Voir le tableau des communes">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
            <line x1="3" y1="9" x2="21" y2="9"></line>
            <line x1="9" y1="21" x2="9" y2="9"></line>
        </svg>
    </button>

    <!-- Panneau tableau -->
    <div id="table-panel" class="table-panel hidden">
        <div class="table-panel-header">
            <h2 class="table-panel-title">Communes par temps d'accès</h2>
            <button id="close-table-btn" class="close-table-btn" aria-label="Fermer">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        </div>
        <div class="table-panel-header">
    <h2 class="table-panel-title">Communes</h2>
    <div class="header-actions">
        <button id="export-csv-btn" class="export-btn" title="Télécharger en CSV">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v4"></path>
                <polyline points="7 10 12 15 17 10"></polyline>
                <line x1="12" y1="15" x2="12" y2="3"></line>
            </svg>
            <span>CSV</span>
        </button>
    </div>
</div>
        <div class="table-panel-content">
            <!-- Filtres -->
            <div class="table-filters">
                <button class="filter-btn active" data-time="all">
                    Toutes <span class="filter-count" id="count-all">0</span>
                </button>
                <button class="filter-btn filter-10min" data-time="600">
                    10 min <span class="filter-count" id="count-600">0</span>
                </button>
                <button class="filter-btn filter-20min" data-time="1200">
                    20 min <span class="filter-count" id="count-1200">0</span>
                </button>
                <button class="filter-btn filter-30min" data-time="1800">
                    30 min <span class="filter-count" id="count-1800">0</span>
                </button>
            </div>

            <!-- Tableau -->
            <div class="table-wrapper">
                <table class="communes-table">
                    <thead>
                        <tr>
                            <th>Commune</th>
                            <th>Code INSEE</th>
                            <th>Temps d'accès</th>
                        </tr>
                    </thead>
                    <tbody id="table-body">
                        <!-- Contenu généré dynamiquement -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

<!-- MODIFICATION : Bottom Sheet avec croix à la place du bouton -->
<div id="bottom-sheet" class="bottom-sheet hidden">
    <div class="bottom-sheet-handle"></div>
    <div class="bottom-sheet-content">
        <!-- Bouton fermer en croix en haut à droite -->
        <button id="close-sheet" class="close-sheet-x" aria-label="Fermer">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
        </button>
        
        <h2 id="feature-name" class="feature-name"></h2>
        <div class="feature-details">
            <!-- Temps d'accès -->
            <div class="detail-row">
                <span class="detail-label">Temps d'accès</span>
                <span id="feature-time" class="detail-value status-time"></span>
            </div>
            
            <!-- Prix appartement -->
            <div class="detail-row">
                <span class="detail-label">Appt. /m²</span>
                <div class="detail-value-group">
                    <span id="feature-prix-appt" class="detail-price"></span>
                    <span id="feature-minmax-appt" class="detail-minmax"></span>
                    <span id="feature-ventes-appt" class="detail-subtitle"></span>
                </div>
            </div>
            
            <!-- Prix maison -->
            <div class="detail-row">
                <span class="detail-label">Maison /m²</span>
                <div class="detail-value-group">
                    <span id="feature-prix-maison" class="detail-price"></span>
                    <span id="feature-minmax-maison" class="detail-minmax"></span>
                    <span id="feature-ventes-maison" class="detail-subtitle"></span>
                </div>
            </div>
        </div>
    </div>
</div>

    <!-- Message d'erreur -->
    <div id="error-message" class="error-message hidden">
        <p id="error-text"></p>
    </div>

    <!-- Script principal -->
    <script src="app.js"></script>
</body>
</html>